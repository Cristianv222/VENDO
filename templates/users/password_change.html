{% extends "users/base_users.html" %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block title %}{% trans "Cambiar Contraseña" %}{% endblock %}

{% block user_breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'users:profile' %}">{% trans "Perfil" %}</a></li>
<li class="breadcrumb-item active">{% trans "Cambiar Contraseña" %}</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i>{% trans "Cambiar Contraseña" %}
                </h5>
            </div>
            
            <div class="card-body">
                {% if user.force_password_change %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {% trans "Debe cambiar su contraseña para continuar usando el sistema." %}
                    </div>
                {% endif %}

                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="{{ form.old_password.id_for_label }}" class="form-label">
                            <i class="fas fa-lock me-2"></i>{{ form.old_password.label }}
                        </label>
                        {{ form.old_password|add_class:"form-control" }}
                        {% if form.old_password.errors %}
                            <div class="text-danger small">{{ form.old_password.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                            <i class="fas fa-key me-2"></i>{{ form.new_password1.label }}
                        </label>
                        {{ form.new_password1|add_class:"form-control" }}
                        {% if form.new_password1.errors %}
                            <div class="text-danger small">{{ form.new_password1.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">
                            <ul class="mb-0 small">
                                <li>{% trans "Debe tener al menos 8 caracteres" %}</li>
                                <li>{% trans "Debe contener letras mayúsculas y minúsculas" %}</li>
                                <li>{% trans "Debe contener al menos un número" %}</li>
                                <li>{% trans "Debe contener al menos un carácter especial" %}</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                            <i class="fas fa-check me-2"></i>{{ form.new_password2.label }}
                        </label>
                        {{ form.new_password2|add_class:"form-control" }}
                        {% if form.new_password2.errors %}
                            <div class="text-danger small">{{ form.new_password2.errors.0 }}</div>
                        {% endif %}
                        <div id="password-match-feedback" class="form-text"></div>
                    </div>

                    <!-- Indicador de fortaleza de contraseña -->
                    <div class="mb-3">
                        <label class="form-label">{% trans "Fortaleza de la contraseña:" %}</label>
                        <div class="progress" style="height: 8px;">
                            <div id="password-strength" class="progress-bar" role="progressbar" 
                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <small id="password-strength-text" class="text-muted"></small>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                            <i class="fas fa-save me-2"></i>{% trans "Cambiar Contraseña" %}
                        </button>
                        {% if not user.force_password_change %}
                            <a href="{% url 'users:profile' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>{% trans "Cancelar" %}
                            </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Consejos de seguridad -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>{% trans "Consejos de Seguridad" %}
                </h6>
            </div>
            <div class="card-body">
                <ul class="mb-0 small">
                    <li>{% trans "Use una contraseña única que no use en otros sitios" %}</li>
                    <li>{% trans "Evite usar información personal en su contraseña" %}</li>
                    <li>{% trans "Considere usar un gestor de contraseñas" %}</li>
                    <li>{% trans "Cambie su contraseña regularmente" %}</li>
                    <li>{% trans "No comparta su contraseña con nadie" %}</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPassword1 = document.getElementById('{{ form.new_password1.id_for_label }}');
    const newPassword2 = document.getElementById('{{ form.new_password2.id_for_label }}');
    const strengthBar = document.getElementById('password-strength');
    const strengthText = document.getElementById('password-strength-text');
    const matchFeedback = document.getElementById('password-match-feedback');
    const submitBtn = document.getElementById('submit-btn');

    function checkPasswordStrength(password) {
        let strength = 0;
        let feedback = [];

        if (password.length >= 8) {
            strength += 20;
        } else {
            feedback.push('{% trans "Mínimo 8 caracteres" %}');
        }

        if (/[a-z]/.test(password)) {
            strength += 20;
        } else {
            feedback.push('{% trans "Letra minúscula" %}');
        }

        if (/[A-Z]/.test(password)) {
            strength += 20;
        } else {
            feedback.push('{% trans "Letra mayúscula" %}');
        }

        if (/[0-9]/.test(password)) {
            strength += 20;
        } else {
            feedback.push('{% trans "Número" %}');
        }

        if (/[^A-Za-z0-9]/.test(password)) {
            strength += 20;
        } else {
            feedback.push('{% trans "Carácter especial" %}');
        }

        return { strength, feedback };
    }

    function updatePasswordStrength() {
        const password = newPassword1.value;
        const result = checkPasswordStrength(password);
        
        strengthBar.style.width = result.strength + '%';
        strengthBar.setAttribute('aria-valuenow', result.strength);
        
        // Colores según fortaleza
        strengthBar.className = 'progress-bar';
        if (result.strength < 40) {
            strengthBar.classList.add('bg-danger');
            strengthText.textContent = '{% trans "Débil" %}';
            strengthText.className = 'text-danger small';
        } else if (result.strength < 80) {
            strengthBar.classList.add('bg-warning');
            strengthText.textContent = '{% trans "Media" %}';
            strengthText.className = 'text-warning small';
        } else {
            strengthBar.classList.add('bg-success');
            strengthText.textContent = '{% trans "Fuerte" %}';
            strengthText.className = 'text-success small';
        }

        if (result.feedback.length > 0) {
            strengthText.textContent += ' - {% trans "Falta:" %} ' + result.feedback.join(', ');
        }

        checkFormValidity();
    }

    function checkPasswordMatch() {
        const password1 = newPassword1.value;
        const password2 = newPassword2.value;

        if (password2) {
            if (password1 === password2) {
                matchFeedback.innerHTML = '<i class="fas fa-check text-success"></i> {% trans "Las contraseñas coinciden" %}';
                matchFeedback.className = 'form-text text-success';
                newPassword2.classList.remove('is-invalid');
                newPassword2.classList.add('is-valid');
            } else {
                matchFeedback.innerHTML = '<i class="fas fa-times text-danger"></i> {% trans "Las contraseñas no coinciden" %}';
                matchFeedback.className = 'form-text text-danger';
                newPassword2.classList.remove('is-valid');
                newPassword2.classList.add('is-invalid');
            }
        } else {
            matchFeedback.textContent = '';
            matchFeedback.className = 'form-text';
            newPassword2.classList.remove('is-valid', 'is-invalid');
        }

        checkFormValidity();
    }

    function checkFormValidity() {
        const password1 = newPassword1.value;
        const password2 = newPassword2.value;
        const result = checkPasswordStrength(password1);
        
        const isValid = password1 && password2 && 
                       password1 === password2 && 
                       result.strength >= 80;
        
        submitBtn.disabled = !isValid;
    }

    newPassword1.addEventListener('input', updatePasswordStrength);
    newPassword2.addEventListener('input', checkPasswordMatch);
    newPassword1.addEventListener('input', checkPasswordMatch);
});
</script>
{% endblock %}