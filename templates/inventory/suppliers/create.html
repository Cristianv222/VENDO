{% extends "inventory/base_inventory.html" %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Crear{% endif %} Proveedor - Inventario{% endblock %}

{% block inventory_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        {% if object %}
            <i class="fas fa-edit"></i> Editar Proveedor
        {% else %}
            <i class="fas fa-plus"></i> Crear Proveedor
        {% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'inventory:supplier_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Proveedores
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <form method="post" id="supplierForm" novalidate>
            {% csrf_token %}
            
            <!-- Información básica -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-building"></i> Información de la Empresa</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    Nombre de la Empresa <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.name.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.ruc.id_for_label }}" class="form-label">
                                    RUC <span class="text-danger">*</span>
                                </label>
                                {{ form.ruc }}
                                {% if form.ruc.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.ruc.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">13 dígitos del RUC ecuatoriano</div>
                                <div id="rucValidation" class="mt-1"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.address.id_for_label }}" class="form-label">Dirección</label>
                        {{ form.address }}
                        {% if form.address.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.address.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            Proveedor activo
                        </label>
                        <div class="form-text">Los proveedores inactivos no aparecen en los formularios</div>
                    </div>
                </div>
            </div>

            <!-- Información de contacto -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-address-card"></i> Información de Contacto</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.contact_person.id_for_label }}" class="form-label">
                            Persona de Contacto
                        </label>
                        {{ form.contact_person }}
                        {% if form.contact_person.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.contact_person.errors.0 }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    {{ form.email }}
                                </div>
                                {% if form.email.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.email.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">Teléfono</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    {{ form.phone }}
                                </div>
                                {% if form.phone.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.phone.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de prueba de contacto -->
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100" 
                                    onclick="testEmail()" id="testEmailBtn" disabled>
                                <i class="fas fa-paper-plane"></i> Probar Email
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-success btn-sm w-100" 
                                    onclick="testPhone()" id="testPhoneBtn" disabled>
                                <i class="fas fa-phone"></i> Llamar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-end gap-2">
                        <a href="{% url 'inventory:supplier_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="button" class="btn btn-outline-info" onclick="validateForm()">
                            <i class="fas fa-check"></i> Validar Datos
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 
                            {% if object %}Actualizar{% else %}Crear{% endif %} Proveedor
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Panel lateral -->
    <div class="col-lg-4">
        {% if object %}
        <!-- Productos de este proveedor -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-boxes"></i> Productos de este Proveedor</h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <h3 class="mb-0">{{ object.product_set.count }}</h3>
                    <p class="text-muted">productos</p>
                    
                    {% if object.product_set.count > 0 %}
                        <a href="{% url 'inventory:product_list' %}?supplier={{ object.pk }}" 
                           class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> Ver Productos
                        </a>
                    {% endif %}
                </div>
                
                {% if object.product_set.count > 0 %}
                    <hr>
                    <h6>Últimos Productos</h6>
                    {% for product in object.product_set.all|slice:":5" %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small">{{ product.name|truncatechars:25 }}</span>
                            <span class="badge bg-secondary">${{ product.cost_price }}</span>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <!-- Historial de compras -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-shopping-cart"></i> Historial</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border rounded p-2 mb-2">
                            <h6 class="mb-0">{{ object.total_purchases|default:0 }}</h6>
                            <small class="text-muted">Compras</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2 mb-2">
                            <h6 class="mb-0">${{ object.total_amount|default:0 }}</h6>
                            <small class="text-muted">Total</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-2">
                    <small class="text-muted">
                        Última compra: 
                        {% if object.last_purchase_date %}
                            {{ object.last_purchase_date|date:"d/m/Y" }}
                        {% else %}
                            Sin compras
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Validador de RUC -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-shield-alt"></i> Validación de Datos</h6>
            </div>
            <div class="card-body">
                <div id="validationResults">
                    <div class="alert alert-info">
                        <small><i class="fas fa-info-circle"></i> Complete los campos para validar</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de proveedores existentes -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-truck"></i> Otros Proveedores</h6>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% for supplier in other_suppliers %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="small">{{ supplier.name|truncatechars:20 }}</span>
                            <br>
                            <small class="text-muted">{{ supplier.ruc }}</small>
                        </div>
                        <span class="badge bg-secondary">{{ supplier.product_set.count }}</span>
                    </div>
                {% empty %}
                    <p class="text-muted small">No hay otros proveedores</p>
                {% endfor %}
            </div>
        </div>

        <!-- Tips -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Consejos</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success"></i> Verifique que el RUC sea válido</li>
                    <li><i class="fas fa-check text-success"></i> Complete toda la información de contacto</li>
                    <li><i class="fas fa-check text-success"></i> Mantenga actualizada la dirección</li>
                    <li><i class="fas fa-check text-success"></i> Use nombres oficiales de empresas</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Validación de RUC en tiempo real
    $('#id_ruc').on('input', function() {
        const ruc = $(this).val();
        if (ruc.length === 13) {
            validateRUC(ruc);
        } else {
            $('#rucValidation').html('');
            $('#id_ruc').removeClass('is-valid is-invalid');
        }
    });

    // Habilitar botones de prueba
    $('#id_email').on('input', function() {
        $('#testEmailBtn').prop('disabled', !$(this).val());
    });

    $('#id_phone').on('input', function() {
        $('#testPhoneBtn').prop('disabled', !$(this).val());
    });

    // Validar al cargar si estamos editando
    {% if object %}
        validateRUC('{{ object.ruc }}');
        updateValidationResults();
    {% endif %}
});

function validateRUC(ruc) {
    if (ruc.length !== 13) {
        $('#rucValidation').html('<small class="text-danger">RUC debe tener 13 dígitos</small>');
        $('#id_ruc').removeClass('is-valid').addClass('is-invalid');
        return false;
    }

    // Validación básica de RUC ecuatoriano
    const provincia = parseInt(ruc.substring(0, 2));
    if (provincia < 1 || provincia > 24) {
        $('#rucValidation').html('<small class="text-danger">Código de provincia inválido</small>');
        $('#id_ruc').removeClass('is-valid').addClass('is-invalid');
        return false;
    }

    const tercerDigito = parseInt(ruc.charAt(2));
    if (tercerDigito > 9) {
        $('#rucValidation').html('<small class="text-danger">Tercer dígito inválido</small>');
        $('#id_ruc').removeClass('is-valid').addClass('is-invalid');
        return false;
    }

    $('#rucValidation').html('<small class="text-success">RUC válido</small>');
    $('#id_ruc').removeClass('is-invalid').addClass('is-valid');
    return true;
}

function validateForm() {
    let isValid = true;
    const validations = [];

    // Validar nombre
    const name = $('#id_name').val();
    if (!name) {
        validations.push('<li class="text-danger">Nombre es requerido</li>');
        isValid = false;
    } else {
        validations.push('<li class="text-success">Nombre válido</li>');
    }

    // Validar RUC
    const ruc = $('#id_ruc').val();
    if (validateRUC(ruc)) {
        validations.push('<li class="text-success">RUC válido</li>');
    } else {
        validations.push('<li class="text-danger">RUC inválido</li>');
        isValid = false;
    }

    // Validar email
    const email = $('#id_email').val();
    if (email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(email)) {
            validations.push('<li class="text-success">Email válido</li>');
        } else {
            validations.push('<li class="text-warning">Email con formato incorrecto</li>');
        }
    }

    // Validar teléfono
    const phone = $('#id_phone').val();
    if (phone) {
        validations.push('<li class="text-success">Teléfono proporcionado</li>');
    }

    updateValidationResults(validations, isValid);
}

function updateValidationResults(validations = null, isValid = true) {
    if (!validations) {
        validations = ['<li class="text-info">Complete el formulario para validar</li>'];
    }

    const alertClass = isValid ? 'alert-success' : 'alert-warning';
    const icon = isValid ? 'fa-check-circle' : 'fa-exclamation-triangle';
    
    $('#validationResults').html(`
        <div class="alert ${alertClass}">
            <small><i class="fas ${icon}"></i> Validación de datos:</small>
            <ul class="mb-0 mt-1">
                ${validations.join('')}
            </ul>
        </div>
    `);
}

function testEmail() {
    const email = $('#id_email').val();
    if (email) {
        window.open(`mailto:${email}?subject=Contacto desde Sistema de Inventario`);
    }
}

function testPhone() {
    const phone = $('#id_phone').val();
    if (phone) {
        window.open(`tel:${phone}`);
    }
}

// Validación en envío del formulario
$('#supplierForm').submit(function(e) {
    const ruc = $('#id_ruc').val();
    if (!validateRUC(ruc)) {
        e.preventDefault();
        showAlert('error', 'Por favor corrija el RUC antes de continuar');
        return false;
    }
});
</script>
{% endblock %}