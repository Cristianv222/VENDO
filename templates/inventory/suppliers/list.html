{% extends "inventory/base_inventory.html" %}
{% load static %}

{% block title %}Proveedores - Inventario{% endblock %}

{% block inventory_content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e0e0e0;">
    <h1 style="color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 12px;">
        <span class="material-icons" style="font-size: 32px;">local_shipping</span>
        Proveedores
    </h1>
    <div style="display: flex; gap: 8px;">
        <button type="button" onclick="openModal()" style="display: flex; align-items: center; gap: 8px; background: var(--primary-color); color: white; padding: 12px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
            <span class="material-icons" style="font-size: 18px;">add</span>
            Nuevo Proveedor
        </button>
        <button type="button" onclick="exportSuppliers()" style="display: flex; align-items: center; gap: 8px; background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            <span class="material-icons" style="font-size: 18px;">download</span>
            Exportar
        </button>
        <button type="button" onclick="importSuppliers()" style="display: flex; align-items: center; gap: 8px; background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            <span class="material-icons" style="font-size: 18px;">upload</span>
            Importar
        </button>
    </div>
</div>

<!-- EstadÃ­sticas -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid var(--primary-color);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary); margin: 8px 0;">{{ total_suppliers|default:0 }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 500;">Total Proveedores</div>
            </div>
            <span class="material-icons" style="font-size: 2.5rem; opacity: 0.3; color: var(--text-secondary);">local_shipping</span>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #28a745;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary); margin: 8px 0;">{{ active_suppliers|default:0 }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 500;">Activos</div>
            </div>
            <span class="material-icons" style="font-size: 2.5rem; opacity: 0.3; color: var(--text-secondary);">check_circle</span>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #17a2b8;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary); margin: 8px 0;">{{ total_products|default:0 }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 500;">Total Productos</div>
            </div>
            <span class="material-icons" style="font-size: 2.5rem; opacity: 0.3; color: var(--text-secondary);">inventory_2</span>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #ffc107;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary); margin: 8px 0;">{{ suppliers_with_contact|default:0 }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 500;">Con Contacto</div>
            </div>
            <span class="material-icons" style="font-size: 2.5rem; opacity: 0.3; color: var(--text-secondary);">contact_phone</span>
        </div>
    </div>
</div>

<!-- Filtros -->
<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 24px;">
    <form method="get" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Buscar</label>
            <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Nombre, RUC o email" 
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Estado</label>
            <select name="is_active" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">Todos</option>
                <option value="true" {% if request.GET.is_active == 'true' %}selected{% endif %}>Activos</option>
                <option value="false" {% if request.GET.is_active == 'false' %}selected{% endif %}>Inactivos</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Contacto</label>
            <select name="has_contact" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">Todos</option>
                <option value="true" {% if request.GET.has_contact == 'true' %}selected{% endif %}>Con contacto</option>
                <option value="false" {% if request.GET.has_contact == 'false' %}selected{% endif %}>Sin contacto</option>
            </select>
        </div>
        <div style="display: flex; align-items: end; gap: 8px;">
            <button type="submit" style="background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="font-size: 18px;">search</span>
                Filtrar
            </button>
            <a href="{% url 'inventory:supplier_list' %}" style="background: transparent; color: var(--text-secondary); border: 1px solid #ddd; padding: 12px 20px; border-radius: 4px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="font-size: 18px;">clear</span>
                Limpiar
            </a>
        </div>
    </form>
</div>

<!-- Tabla de proveedores -->
<div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div style="padding: 20px; border-bottom: 1px solid #e0e0e0;">
        <h2 style="margin: 0; color: var(--text-primary); font-size: 18px;">Lista de Proveedores</h2>
        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px;">
            {% if suppliers %}
                Mostrando {{ suppliers|length }} proveedores
            {% else %}
                No se encontraron proveedores
            {% endif %}
        </p>
    </div>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 16px; text-align: left; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: var(--text-primary);">Proveedor</th>
                    <th style="padding: 16px; text-align: left; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: var(--text-primary);">RUC</th>
                    <th style="padding: 16px; text-align: left; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: var(--text-primary);">Contacto</th>
                    <th style="padding: 16px; text-align: left; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: var(--text-primary);">Productos</th>
                    <th style="padding: 16px; text-align: left; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: var(--text-primary);">Estado</th>
                    <th style="padding: 16px; text-align: center; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: var(--text-primary);">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for supplier in suppliers %}
                <tr style="border-bottom: 1px solid #f0f0f0;" data-supplier-id="{{ supplier.pk }}">
                    <td style="padding: 16px;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">{{ supplier.name }}</div>
                            {% if supplier.address %}
                                <div style="font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;">
                                    <span class="material-icons" style="font-size: 14px;">location_on</span>
                                    {{ supplier.address|truncatechars:50 }}
                                </div>
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 16px;">
                        <span style="padding: 4px 8px; background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 4px; font-family: monospace; font-size: 13px;">{{ supplier.ruc }}</span>
                    </td>
                    <td style="padding: 16px;">
                        <div>
                            {% if supplier.contact_person %}
                                <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 4px;">{{ supplier.contact_person }}</div>
                            {% endif %}
                            {% if supplier.email %}
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px; display: flex; align-items: center; gap: 4px;">
                                    <span class="material-icons" style="font-size: 14px;">email</span>
                                    <a href="mailto:{{ supplier.email }}" style="color: var(--primary-color); text-decoration: none;">{{ supplier.email }}</a>
                                </div>
                            {% endif %}
                            {% if supplier.phone %}
                                <div style="font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;">
                                    <span class="material-icons" style="font-size: 14px;">phone</span>
                                    <a href="tel:{{ supplier.phone }}" style="color: var(--primary-color); text-decoration: none;">{{ supplier.phone }}</a>
                                </div>
                            {% endif %}
                            {% if not supplier.email and not supplier.phone %}
                                <span style="color: var(--text-secondary); font-size: 12px;">Sin datos de contacto</span>
                            {% endif %}
                        </div>
                    </td>
                    <td style="padding: 16px;">
                        <a href="{% url 'inventory:product_list' %}?supplier={{ supplier.pk }}" 
                           style="display: inline-flex; align-items: center; gap: 4px; padding: 6px 12px; background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); border-radius: 4px; text-decoration: none; font-size: 12px;">
                            <span class="material-icons" style="font-size: 14px;">inventory_2</span>
                            {{ supplier.products_count|default:0 }}
                        </a>
                    </td>
                    <td style="padding: 16px;">
                        {% if supplier.is_active %}
                            <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; background: #e8f5e8; color: #2e7d32;">Activo</span>
                        {% else %}
                            <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; background: #f5f5f5; color: #666;">Inactivo</span>
                        {% endif %}
                    </td>
                    <td style="padding: 16px; text-align: center;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button type="button" onclick="viewSupplier('{{ supplier.pk }}')"
                                    style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border: 1px solid var(--primary-color); color: var(--primary-color); background: transparent; border-radius: 4px; cursor: pointer;" 
                                    title="Ver detalles">
                                <span class="material-icons" style="font-size: 16px;">visibility</span>
                            </button>
                            <button type="button" onclick="editSupplier('{{ supplier.pk }}')"
                                    style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border: 1px solid #6c757d; color: #6c757d; background: transparent; border-radius: 4px; cursor: pointer;" 
                                    title="Editar">
                                <span class="material-icons" style="font-size: 16px;">edit</span>
                            </button>
                            {% if supplier.email %}
                                <button type="button" onclick="contactSupplier('{{ supplier.pk }}')"
                                        style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border: 1px solid #17a2b8; color: #17a2b8; background: transparent; border-radius: 4px; cursor: pointer;" 
                                        title="Contactar">
                                    <span class="material-icons" style="font-size: 16px;">email</span>
                                </button>
                            {% endif %}
                            {% if supplier.products_count == 0 %}
                                <button type="button" onclick="deleteSupplier('{{ supplier.pk }}')"
                                        style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border: 1px solid #dc3545; color: #dc3545; background: transparent; border-radius: 4px; cursor: pointer;" 
                                        title="Eliminar">
                                    <span class="material-icons" style="font-size: 16px;">delete</span>
                                </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="padding: 60px 20px; text-align: center; color: var(--text-secondary);">
                        <span class="material-icons" style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">local_shipping</span>
                        <div style="font-size: 18px; margin-bottom: 8px;">No se encontraron proveedores</div>
                        <div style="font-size: 14px; margin-bottom: 24px;">
                            {% if request.GET.search or request.GET.is_active or request.GET.has_contact %}
                                Intenta ajustar los filtros o 
                                <a href="{% url 'inventory:supplier_list' %}" style="color: var(--primary-color); text-decoration: none;">ver todos los proveedores</a>
                            {% else %}
                                Comienza agregando tu primer proveedor
                            {% endif %}
                        </div>
                        <button type="button" onclick="openModal()" style="display: inline-flex; align-items: center; gap: 8px; background: var(--primary-color); color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
                            <span class="material-icons" style="font-size: 18px;">add</span>
                            Crear primer proveedor
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- PaginaciÃ³n -->
    {% if is_paginated %}
    <div style="padding: 20px; border-top: 1px solid #e0e0e0;">
        <nav style="display: flex; justify-content: center;">
            <div style="display: flex; gap: 8px; align-items: center;">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.has_contact %}&has_contact={{ request.GET.has_contact }}{% endif %}" 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">Primera</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.has_contact %}&has_contact={{ request.GET.has_contact }}{% endif %}" 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">Anterior</a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span style="padding: 8px 12px; background: var(--primary-color); color: white; border-radius: 4px; font-weight: 500;">{{ num }}</span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.has_contact %}&has_contact={{ request.GET.has_contact }}{% endif %}" 
                           style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.has_contact %}&has_contact={{ request.GET.has_contact }}{% endif %}" 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">Siguiente</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}{% if request.GET.has_contact %}&has_contact={{ request.GET.has_contact }}{% endif %}" 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">Ãltima</a>
                {% endif %}
            </div>
        </nav>
    </div>
    {% endif %}
</div>

<!-- NavegaciÃ³n rÃ¡pida -->
<div style="margin-top: 24px; display: flex; gap: 16px; justify-content: center;">
    <a href="{% url 'inventory:dashboard' %}" style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); text-decoration: none;">
        <span class="material-icons">arrow_back</span>
        Volver al Dashboard
    </a>
    <a href="{% url 'inventory:category_list' %}" style="display: flex; align-items: center; gap: 8px; color: var(--primary-color); text-decoration: none;">
        <span class="material-icons">label</span>
        Gestionar CategorÃ­as
    </a>
    <a href="{% url 'inventory:brand_list' %}" style="display: flex; align-items: center; gap: 8px; color: var(--primary-color); text-decoration: none;">
        <span class="material-icons">star</span>
        Gestionar Marcas
    </a>
    <a href="{% url 'inventory:product_list' %}" style="display: flex; align-items: center; gap: 8px; color: var(--primary-color); text-decoration: none;">
        <span class="material-icons">inventory_2</span>
        Gestionar Productos
    </a>
</div>

<!-- Modal de proveedor -->
<div id="supplierModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="supplierModalTitle" style="margin: 0; color: var(--text-primary);">Nuevo Proveedor</h3>
            <button type="button" onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">
                <span class="material-icons">close</span>
            </button>
        </div>
        <form id="supplierForm">
            <div style="padding: 20px;">
                {% csrf_token %}
                <input type="hidden" id="supplierId" name="supplier_id">
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Nombre <span style="color: #dc3545;">*</span></label>
                        <input type="text" id="name" name="name" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">RUC <span style="color: #dc3545;">*</span></label>
                        <input type="text" id="ruc" name="ruc" maxlength="13" pattern="[0-9]{13}" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">13 dÃ­gitos</div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Email</label>
                        <input type="email" id="email" name="email" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">TelÃ©fono</label>
                        <input type="tel" id="phone" name="phone" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Persona de Contacto</label>
                    <input type="text" id="contact_person" name="contact_person" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">DirecciÃ³n</label>
                    <textarea id="address" name="address" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="is_active" name="is_active" checked style="width: 16px; height: 16px;">
                        <span style="color: var(--text-primary); font-weight: 500;">Proveedor activo</span>
                    </label>
                </div>
            </div>
            <div style="padding: 0 20px 20px; display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="closeModal()" style="background: transparent; color: var(--text-secondary); border: 1px solid #ddd; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500;">Cancelar</button>
                <button type="submit" style="background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons" style="font-size: 18px;">save</span>
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de detalles -->
<div id="supplierDetailModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; border-radius: 8px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: var(--text-primary);">Detalles del Proveedor</h3>
            <button type="button" onclick="closeDetailModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div style="padding: 20px;">
            <div id="supplierDetailContent">
                <!-- Se carga dinÃ¡micamente -->
            </div>
        </div>
        <div style="padding: 0 20px 20px; display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" onclick="closeDetailModal()" style="background: transparent; color: var(--text-secondary); border: 1px solid #ddd; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500;">Cerrar</button>
            <button type="button" onclick="editSupplierFromDetail()" style="background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="font-size: 18px;">edit</span>
                Editar
            </button>
        </div>
    </div>
</div>

<!-- Modal de contacto -->
<div id="contactModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: var(--text-primary);">Contactar Proveedor</h3>
            <button type="button" onclick="closeContactModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div style="padding: 20px;">
            <div id="contactInfo" style="margin-bottom: 20px;">
                <!-- Se carga dinÃ¡micamente -->
            </div>
            
            <form id="contactForm">
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Asunto</label>
                    <input type="text" id="subject" name="subject" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Mensaje</label>
                    <textarea id="message" name="message" rows="4" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </form>
        </div>
        <div style="padding: 0 20px 20px; display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" onclick="closeContactModal()" style="background: transparent; color: var(--text-secondary); border: 1px solid #ddd; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500;">Cancelar</button>
            <button type="button" onclick="sendContact()" style="background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="font-size: 18px;">send</span>
                Enviar
            </button>
        </div>
    </div>
</div>

<script>
// Variables globales
const API_BASE_URL = '/inventory/api/suppliers/';
let currentSupplierId = null;

// Funciones de modal
function openModal() {
    document.getElementById('supplierModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('supplierModal').style.display = 'none';
    resetForm();
}

function closeDetailModal() {
    document.getElementById('supplierDetailModal').style.display = 'none';
}

function closeContactModal() {
    document.getElementById('contactModal').style.display = 'none';
    document.getElementById('contactForm').reset();
}

function resetForm() {
    document.getElementById('supplierForm').reset();
    document.getElementById('supplierId').value = '';
    document.getElementById('supplierModalTitle').textContent = 'Nuevo Proveedor';
    document.getElementById('ruc').style.borderColor = '#ddd';
}

// ValidaciÃ³n de RUC
function validateRUC(ruc) {
    if (ruc.length !== 13 || !/^\d{13}$/.test(ruc)) {
        document.getElementById('ruc').style.borderColor = '#dc3545';
        return false;
    }
    document.getElementById('ruc').style.borderColor = '#28a745';
    return true;
}

// ValidaciÃ³n en tiempo real
document.getElementById('ruc').addEventListener('input', function() {
    const ruc = this.value;
    if (ruc.length === 13) {
        validateRUC(ruc);
    } else if (ruc.length > 0) {
        this.style.borderColor = '#ddd';
    }
});

function editSupplier(supplierId) {
    fetch(API_BASE_URL + supplierId + '/')
        .then(response => {
            if (!response.ok) throw new Error('Error al cargar los datos');
            return response.json();
        })
        .then(supplier => {
            document.getElementById('supplierModalTitle').textContent = 'Editar Proveedor';
            document.getElementById('supplierId').value = supplier.id;
            document.getElementById('name').value = supplier.name;
            document.getElementById('ruc').value = supplier.ruc;
            document.getElementById('email').value = supplier.email || '';
            document.getElementById('phone').value = supplier.phone || '';
            document.getElementById('contact_person').value = supplier.contact_person || '';
            document.getElementById('address').value = supplier.address || '';
            document.getElementById('is_active').checked = supplier.is_active;
            
            openModal();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al cargar los datos del proveedor');
        });
}

function viewSupplier(supplierId) {
    fetch(API_BASE_URL + supplierId + '/')
        .then(response => {
            if (!response.ok) throw new Error('Error al cargar los datos');
            return response.json();
        })
        .then(supplier => {
            currentSupplierId = supplierId;
            
            const content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h6 style="color: var(--text-primary); margin-bottom: 12px;">InformaciÃ³n General</h6>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            <div style="margin-bottom: 8px;"><strong>Nombre:</strong> ${supplier.name}</div>
                            <div style="margin-bottom: 8px;"><strong>RUC:</strong> <span style="font-family: monospace;">${supplier.ruc}</span></div>
                            <div><strong>Estado:</strong> 
                                ${supplier.is_active ? 
                                    '<span style="color: #28a745;">Activo</span>' : 
                                    '<span style="color: #6c757d;">Inactivo</span>'
                                }
                            </div>
                        </div>
                    </div>
                    <div>
                        <h6 style="color: var(--text-primary); margin-bottom: 12px;">Contacto</h6>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            <div style="margin-bottom: 8px;"><strong>Persona:</strong> ${supplier.contact_person || 'No especificado'}</div>
                            <div style="margin-bottom: 8px;"><strong>Email:</strong> 
                                ${supplier.email ? 
                                    `<a href="mailto:${supplier.email}" style="color: var(--primary-color);">${supplier.email}</a>` : 
                                    'No especificado'
                                }
                            </div>
                            <div><strong>TelÃ©fono:</strong> 
                                ${supplier.phone ? 
                                    `<a href="tel:${supplier.phone}" style="color: var(--primary-color);">${supplier.phone}</a>` : 
                                    'No especificado'
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                ${supplier.address ? `
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: var(--text-primary); margin-bottom: 12px;">DirecciÃ³n</h6>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            ${supplier.address}
                        </div>
                    </div>
                ` : ''}
                
                <div>
                    <h6 style="color: var(--text-primary); margin-bottom: 12px;">EstadÃ­sticas</h6>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">${supplier.products_count || 0}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Productos</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                                ${supplier.last_purchase_date ? new Date(supplier.last_purchase_date).toLocaleDateString() : 'N/A'}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Ãltima Compra</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('supplierDetailContent').innerHTML = content;
            document.getElementById('supplierDetailModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al cargar los detalles del proveedor');
        });
}

function editSupplierFromDetail() {
    closeDetailModal();
    setTimeout(() => editSupplier(currentSupplierId), 300);
}

function deleteSupplier(supplierId) {
    if (confirm('Â¿EstÃ¡ seguro de que desea eliminar este proveedor?')) {
        fetch(API_BASE_URL + supplierId + '/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                showAlert('success', 'Proveedor eliminado exitosamente');
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error('Error al eliminar');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al eliminar el proveedor');
        });
    }
}

function contactSupplier(supplierId) {
    fetch(API_BASE_URL + supplierId + '/')
        .then(response => {
            if (!response.ok) throw new Error('Error al cargar los datos');
            return response.json();
        })
        .then(supplier => {
            if (!supplier.email) {
                showAlert('warning', 'Este proveedor no tiene email registrado');
                return;
            }
            
            const contactInfo = `
                <div style="padding: 16px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">${supplier.name}</div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <span class="material-icons" style="font-size: 16px;">email</span>
                        ${supplier.email}
                    </div>
                    ${supplier.contact_person ? `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons" style="font-size: 16px;">person</span>
                            ${supplier.contact_person}
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('contactInfo').innerHTML = contactInfo;
            document.getElementById('contactModal').style.display = 'flex';
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al cargar los datos del proveedor');
        });
}

function sendContact() {
    const subject = document.getElementById('subject').value;
    const message = document.getElementById('message').value;
    
    if (!subject || !message) {
        showAlert('error', 'Complete todos los campos');
        return;
    }
    
    // AquÃ­ implementarÃ­as el envÃ­o del email
    showAlert('success', 'Mensaje enviado exitosamente');
    closeContactModal();
}

function exportSuppliers() {
    window.open(API_BASE_URL + '?format=xlsx');
}

function importSuppliers() {
    showAlert('info', 'Funcionalidad de importaciÃ³n en desarrollo');
}

// Manejar formulario
document.getElementById('supplierForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const supplierId = document.getElementById('supplierId').value;
    const formData = {
        name: document.getElementById('name').value,
        ruc: document.getElementById('ruc').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        contact_person: document.getElementById('contact_person').value,
        address: document.getElementById('address').value,
        is_active: document.getElementById('is_active').checked
    };
    
    // Validar RUC
    if (!validateRUC(formData.ruc)) {
        showAlert('error', 'RUC invÃ¡lido (debe tener 13 dÃ­gitos)');
        return;
    }
    
    const url = supplierId ? API_BASE_URL + supplierId + '/' : API_BASE_URL;
    const method = supplierId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Error al guardar');
        }
    })
    .then(data => {
        if (data.id) {
            showAlert('success', 'Proveedor guardado exitosamente');
            closeModal();
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error al guardar el proveedor');
    });
});

// Cerrar modales al hacer clic fuera
document.getElementById('supplierModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

document.getElementById('supplierDetailModal').addEventListener('click', function(e) {
    if (e.target === this) closeDetailModal();
});

document.getElementById('contactModal').addEventListener('click', function(e) {
    if (e.target === this) closeContactModal();
});

// FunciÃ³n para obtener el token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// FunciÃ³n para mostrar alertas
function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1100;
        min-width: 300px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        ${type === 'success' 
            ? 'background: #e8f5e8; color: #2e7d32; border-left: 4px solid #28a745;' 
            : type === 'warning'
            ? 'background: #fff3e0; color: #ef6c00; border-left: 4px solid #ffc107;'
            : type === 'info'
            ? 'background: #e3f2fd; color: #1976d2; border-left: 4px solid #2196f3;'
            : 'background: #ffebee; color: #c62828; border-left: 4px solid #dc3545;'}
    `;
    
    alert.innerHTML = `
        <span class="material-icons">${
            type === 'success' ? 'check_circle' : 
            type === 'warning' ? 'warning' :
            type === 'info' ? 'info' : 'error'
        }</span>
        ${message}
        <button onclick="this.parentElement.remove()" style="background: none; border: none; margin-left: auto; cursor: pointer; color: inherit;">
            <span class="material-icons">close</span>
        </button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}
</script>

{% endblock %}