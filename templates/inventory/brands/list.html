{% extends "inventory/base_inventory.html" %}
{% load static %}

{% block title %}Marcas - Inventario{% endblock %}

{% block inventory_content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e0e0e0;">
    <h1 style="color: var(--primary-color); margin: 0; display: flex; align-items: center; gap: 12px;">
        <span class="material-icons" style="font-size: 32px;">star</span>
        Marcas
    </h1>
    <div style="display: flex; gap: 8px;">
        <button type="button" onclick="openModal()" style="display: flex; align-items: center; gap: 8px; background: var(--primary-color); color: white; padding: 12px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
            <span class="material-icons" style="font-size: 18px;">add</span>
            Nueva Marca
        </button>
        <button type="button" onclick="exportBrands()" style="display: flex; align-items: center; gap: 8px; background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); padding: 12px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
            <span class="material-icons" style="font-size: 18px;">download</span>
            Exportar
        </button>
    </div>
</div>

<!-- Estadísticas -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid var(--primary-color);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary); margin: 8px 0;">{{ total_brands|default:0 }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 500;">Total Marcas</div>
            </div>
            <span class="material-icons" style="font-size: 2.5rem; opacity: 0.3; color: var(--text-secondary);">star</span>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #28a745;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary); margin: 8px 0;">{{ active_brands|default:0 }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 500;">Marcas Activas</div>
            </div>
            <span class="material-icons" style="font-size: 2.5rem; opacity: 0.3; color: var(--text-secondary);">check_circle</span>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #17a2b8;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary); margin: 8px 0;">{{ total_products|default:0 }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 500;">Total Productos</div>
            </div>
            <span class="material-icons" style="font-size: 2.5rem; opacity: 0.3; color: var(--text-secondary);">inventory_2</span>
        </div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #ffc107;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary); margin: 8px 0;">{{ brands_with_logo|default:0 }}</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); text-transform: uppercase; font-weight: 500;">Con Logo</div>
            </div>
            <span class="material-icons" style="font-size: 2.5rem; opacity: 0.3; color: var(--text-secondary);">image</span>
        </div>
    </div>
</div>

<!-- Filtros -->
<div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 24px;">
    <form method="get" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Buscar</label>
            <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Nombre o descripción" 
                   style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Estado</label>
            <select name="is_active" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                <option value="">Todos</option>
                <option value="true" {% if request.GET.is_active == 'true' %}selected{% endif %}>Activos</option>
                <option value="false" {% if request.GET.is_active == 'false' %}selected{% endif %}>Inactivos</option>
            </select>
        </div>
        <div style="display: flex; align-items: end; gap: 8px;">
            <button type="submit" style="background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="font-size: 18px;">search</span>
                Filtrar
            </button>
            <a href="{% url 'inventory:brand_list' %}" style="background: transparent; color: var(--text-secondary); border: 1px solid #ddd; padding: 12px 20px; border-radius: 4px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                <span class="material-icons" style="font-size: 18px;">clear</span>
                Limpiar
            </a>
        </div>
    </form>
</div>

<!-- Grid de marcas -->
<div style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <div style="padding: 20px; border-bottom: 1px solid #e0e0e0;">
        <h2 style="margin: 0; color: var(--text-primary); font-size: 18px;">Lista de Marcas</h2>
        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px;">
            {% if brands %}
                Mostrando {{ brands|length }} marcas
            {% else %}
                No se encontraron marcas
            {% endif %}
        </p>
    </div>

    {% if brands %}
    <div style="padding: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
            {% for brand in brands %}
            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; transition: all 0.3s ease; cursor: pointer;" 
                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                
                <!-- Logo y nombre -->
                <div style="text-align: center; margin-bottom: 16px;">
                    <div style="width: 80px; height: 60px; margin: 0 auto 12px; border-radius: 8px; overflow: hidden; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                        {% if brand.logo %}
                            <img src="{{ brand.logo.url }}" alt="{{ brand.name }}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        {% else %}
                            <span class="material-icons" style="color: #ccc; font-size: 32px;">star</span>
                        {% endif %}
                    </div>
                    <h3 style="margin: 0; color: var(--text-primary); font-size: 18px; font-weight: 600;">{{ brand.name }}</h3>
                    {% if brand.description %}
                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px; line-height: 1.4;">{{ brand.description|truncatechars:80 }}</p>
                    {% endif %}
                </div>

                <!-- Estadísticas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                    <div style="text-align: center;">
                        <div style="font-size: 20px; font-weight: 600; color: var(--text-primary);">{{ brand.products_count|default:0 }}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase;">Productos</div>
                    </div>
                    <div style="text-align: center;">
                        {% if brand.is_active %}
                            <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; background: #e8f5e8; color: #2e7d32;">Activo</span>
                        {% else %}
                            <span style="padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; background: #f5f5f5; color: #666;">Inactivo</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Acciones -->
                <div style="display: flex; gap: 8px; justify-content: center;">
                    <a href="{% url 'inventory:product_list' %}?brand={{ brand.pk }}" 
                       style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border: 1px solid var(--primary-color); color: var(--primary-color); border-radius: 4px; text-decoration: none;" 
                       title="Ver productos">
                        <span class="material-icons" style="font-size: 16px;">inventory_2</span>
                    </a>
                    <button type="button" onclick="editBrand('{{ brand.pk }}')"
                            style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border: 1px solid #6c757d; color: #6c757d; background: transparent; border-radius: 4px; cursor: pointer;" 
                            title="Editar">
                        <span class="material-icons" style="font-size: 16px;">edit</span>
                    </button>
                    {% if brand.products_count == 0 %}
                        <button type="button" onclick="deleteBrand('{{ brand.pk }}')"
                                style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border: 1px solid #dc3545; color: #dc3545; background: transparent; border-radius: 4px; cursor: pointer;" 
                                title="Eliminar">
                            <span class="material-icons" style="font-size: 16px;">delete</span>
                        </button>
                    {% endif %}
                </div>

                <!-- Fecha de creación -->
                <div style="text-align: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                    <span style="font-size: 12px; color: var(--text-secondary);">Creado: {{ brand.created_at|date:"d/m/Y" }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div style="padding: 60px 20px; text-align: center; color: var(--text-secondary);">
        <span class="material-icons" style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">star</span>
        <div style="font-size: 18px; margin-bottom: 8px;">No se encontraron marcas</div>
        <div style="font-size: 14px; margin-bottom: 24px;">
            {% if request.GET.search or request.GET.is_active %}
                Intenta ajustar los filtros o 
                <a href="{% url 'inventory:brand_list' %}" style="color: var(--primary-color); text-decoration: none;">ver todas las marcas</a>
            {% else %}
                Comienza agregando tu primera marca
            {% endif %}
        </div>
        <button type="button" onclick="openModal()" style="display: inline-flex; align-items: center; gap: 8px; background: var(--primary-color); color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
            <span class="material-icons" style="font-size: 18px;">add</span>
            Crear primera marca
        </button>
    </div>
    {% endif %}

    <!-- Paginación -->
    {% if is_paginated %}
    <div style="padding: 20px; border-top: 1px solid #e0e0e0;">
        <nav style="display: flex; justify-content: center;">
            <div style="display: flex; gap: 8px; align-items: center;">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}" 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">Primera</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}" 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">Anterior</a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span style="padding: 8px 12px; background: var(--primary-color); color: white; border-radius: 4px; font-weight: 500;">{{ num }}</span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}" 
                           style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}" 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">Siguiente</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.is_active %}&is_active={{ request.GET.is_active }}{% endif %}" 
                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: var(--text-primary);">Última</a>
                {% endif %}
            </div>
        </nav>
    </div>
    {% endif %}
</div>

<!-- Navegación rápida -->
<div style="margin-top: 24px; display: flex; gap: 16px; justify-content: center;">
    <a href="{% url 'inventory:dashboard' %}" style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); text-decoration: none;">
        <span class="material-icons">arrow_back</span>
        Volver al Dashboard
    </a>
    <a href="{% url 'inventory:category_list' %}" style="display: flex; align-items: center; gap: 8px; color: var(--primary-color); text-decoration: none;">
        <span class="material-icons">label</span>
        Gestionar Categorías
    </a>
    <a href="{% url 'inventory:product_list' %}" style="display: flex; align-items: center; gap: 8px; color: var(--primary-color); text-decoration: none;">
        <span class="material-icons">inventory_2</span>
        Gestionar Productos
    </a>
</div>

<!-- Modal -->
<div id="brandModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
    <div style="background: white; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="brandModalTitle" style="margin: 0; color: var(--text-primary);">Nueva Marca</h3>
            <button type="button" onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">
                <span class="material-icons">close</span>
            </button>
        </div>
        <form id="brandForm" enctype="multipart/form-data">
            <div style="padding: 20px;">
                {% csrf_token %}
                <input type="hidden" id="brandId" name="brand_id">
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Nombre <span style="color: #dc3545;">*</span></label>
                    <input type="text" id="name" name="name" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Descripción</label>
                    <textarea id="description" name="description" rows="3" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary);">Logo</label>
                    <input type="file" id="logo" name="logo" accept="image/*" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">Formatos: JPG, PNG, GIF. Máximo 2MB</div>
                    
                    <div id="logoPreview" style="margin-top: 16px; text-align: center; display: none;">
                        <img id="logoPreviewImg" src="" alt="Logo preview" style="max-height: 100px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <br>
                        <button type="button" onclick="removeLogo()" style="margin-top: 8px; background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <span class="material-icons" style="font-size: 14px; vertical-align: middle;">delete</span>
                            Quitar
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="is_active" name="is_active" checked style="width: 16px; height: 16px;">
                        <span style="color: var(--text-primary); font-weight: 500;">Marca activa</span>
                    </label>
                </div>
            </div>
            <div style="padding: 0 20px 20px; display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" onclick="closeModal()" style="background: transparent; color: var(--text-secondary); border: 1px solid #ddd; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500;">Cancelar</button>
                <button type="submit" style="background: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                    <span class="material-icons" style="font-size: 18px;">save</span>
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Variables globales
const API_BASE_URL = '/inventory/api/brands/';

// Funciones del modal
function openModal() {
    document.getElementById('brandModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('brandModal').style.display = 'none';
    resetForm();
}

function resetForm() {
    document.getElementById('brandForm').reset();
    document.getElementById('brandId').value = '';
    document.getElementById('brandModalTitle').textContent = 'Nueva Marca';
    document.getElementById('logoPreview').style.display = 'none';
}

// Preview de logo
document.getElementById('logo').addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('logoPreviewImg').src = e.target.result;
            document.getElementById('logoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

function editBrand(brandId) {
    fetch(API_BASE_URL + brandId + '/')
        .then(response => {
            if (!response.ok) throw new Error('Error al cargar los datos');
            return response.json();
        })
        .then(brand => {
            document.getElementById('brandModalTitle').textContent = 'Editar Marca';
            document.getElementById('brandId').value = brand.id;
            document.getElementById('name').value = brand.name;
            document.getElementById('description').value = brand.description;
            document.getElementById('is_active').checked = brand.is_active;
            
            if (brand.logo) {
                document.getElementById('logoPreviewImg').src = brand.logo;
                document.getElementById('logoPreview').style.display = 'block';
            }
            
            openModal();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al cargar los datos de la marca');
        });
}

function deleteBrand(brandId) {
    if (confirm('¿Está seguro de que desea eliminar esta marca?')) {
        fetch(API_BASE_URL + brandId + '/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (response.ok) {
                showAlert('success', 'Marca eliminada exitosamente');
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error('Error al eliminar');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Error al eliminar la marca');
        });
    }
}

function removeLogo() {
    document.getElementById('logo').value = '';
    document.getElementById('logoPreview').style.display = 'none';
}

function exportBrands() {
    window.open(API_BASE_URL + '?format=xlsx');
}

// Manejar formulario
document.getElementById('brandForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const brandId = document.getElementById('brandId').value;
    const formData = new FormData(this);
    
    const url = brandId ? API_BASE_URL + brandId + '/' : API_BASE_URL;
    const method = brandId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            throw new Error('Error al guardar');
        }
    })
    .then(data => {
        if (data.id) {
            showAlert('success', 'Marca guardada exitosamente');
            closeModal();
            setTimeout(() => location.reload(), 1000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Error al guardar la marca');
    });
});

// Cerrar modal al hacer clic fuera
document.getElementById('brandModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Función para obtener el token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para mostrar alertas
function showAlert(type, message) {
    const alert = document.createElement('div');
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1100;
        min-width: 300px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        ${type === 'success' 
            ? 'background: #e8f5e8; color: #2e7d32; border-left: 4px solid #28a745;' 
            : 'background: #ffebee; color: #c62828; border-left: 4px solid #dc3545;'}
    `;
    
    alert.innerHTML = `
        <span class="material-icons">${type === 'success' ? 'check_circle' : 'error'}</span>
        ${message}
        <button onclick="this.parentElement.remove()" style="background: none; border: none; margin-left: auto; cursor: pointer; color: inherit;">
            <span class="material-icons">close</span>
        </button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentElement) {
            alert.remove();
        }
    }, 5000);
}
</script>

{% endblock %}